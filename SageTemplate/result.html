<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { 
            background-color: #f8f9fa; 
            overflow-x: hidden;
        }
        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }
        #sidebar {
            width: 250px;
            min-height: 100vh;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
        }
        #content {
            flex: 1;
            padding: 20px;
            min-height: 100vh;
        }
        pre {
            background-color: #f1f3f5;
            padding: 15px;
            border-radius: 5px;
            position: relative;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .answer { overflow-wrap: break-word; }
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 5px 10px;
            font-size: 12px;
        }
        .mermaid, .jobflow-diagram {
            background-color: white;
            padding: 10px;
            margin-bottom: 10px;
            overflow-x: auto;
        }
        .jobflow-diagram {
            width: 100%;
            height: auto;
            max-width: 100%;
        }
        .jobflow-diagram svg {
            width: 100%;
            height: auto;
            max-width: 100%;
        }
        .history {
            max-height: 800px;
            overflow-y: auto;
        }
        .header-title { cursor: pointer; }
        .code-container {
            position: relative;
            overflow-x: auto;
        }
        .delete-button {
            cursor: pointer;
            color: #dc3545;
            margin-left: 4px;
        }
        .question-card { position: relative; }
        .copy-question-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="position-sticky pt-3">
                <h5 class="p-3">Question History</h5>
                <div class="list-group history">
                    {% for item in questions %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('show_question', question_id=item.doc_id) }}" class="flex-grow-1">{{ item.title }}</a>
                            <i class="bi bi-trash delete-button" data-question-id="{{ item.doc_id }}"></i>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <h1 class="header-title" onclick="window.location='/'">Code Sage</h1>
                </div>
            </nav>

            <div class="card mb-4 question-card">
                <div class="card-header">
                    <h5 class="card-title">Question</h5>
                    <button class="btn btn-sm btn-secondary copy-question-btn">Copy Question</button>
                </div>
                <div class="card-body">
                    <pre class="card-text">{{ question }}</pre>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Answer</h5>
                </div>
                <div class="card-body">
                    <div class="answer" id="answer-content">{{ answer | e }}</div>
                </div>
            </div>
            <a href="/" class="btn btn-primary mt-3">Ask Another Question</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://job-flow.s3.ap-northeast-2.amazonaws.com/jobflow.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const answerElement = document.getElementById('answer-content');
            const markdownContent = answerElement.textContent;

            const renderer = new marked.Renderer();
            const originalCodeRenderer = renderer.code.bind(renderer);
            
            renderer.code = function(code, language) {
                if (language === 'jobflow') {
                    const svg = JobFlowToSVG.generateSVG(code);
                    const viewBox = svg.match(/viewBox="([^"]+)"/)[1];
                    const modifiedSvg = svg.replace(/<svg[^>]*>/, `<svg viewBox="${viewBox}">`);
                    return `<div class="jobflow-diagram">${modifiedSvg}</div>`;
                }
                return originalCodeRenderer(code, language);
            };
            
            const htmlContent = marked.parse(markdownContent, { renderer: renderer });
            answerElement.innerHTML = htmlContent;

            function createCopyButton(text) {
                const button = document.createElement('button');
                button.textContent = 'Copy';
                button.className = 'btn btn-sm btn-secondary copy-btn';
                button.addEventListener('click', function () {
                    navigator.clipboard.writeText(text).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                return button;
            }

            function processCodeBlock(block) {
                if (block.classList.contains('language-mermaid')) {
                    processMermaidDiagram(block);
                } else if (block.classList.contains('language-jobflow')) {
                    processJobFlowDiagram(block);
                } else {
                    hljs.highlightElement(block);
                    const button = createCopyButton(block.textContent);
                    block.parentNode.insertBefore(button, block);
                }
            }

            function processMermaidDiagram(el) {
                const mermaidDiv = document.createElement('div');
                mermaidDiv.classList.add('mermaid');
                mermaidDiv.textContent = el.textContent;

                const copyButton = createCopyButton(el.textContent);
                const containerDiv = document.createElement('div');
                containerDiv.style.position = 'relative';
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';

                containerDiv.appendChild(mermaidDiv);
                containerDiv.appendChild(copyButton);
                el.parentNode.replaceChild(containerDiv, el);
            }

            function processJobFlowDiagram(el) {
                const jobFlowDiv = document.createElement('div');
                jobFlowDiv.classList.add('jobflow-diagram');
                const svg = JobFlowToSVG.generateSVG(el.textContent);
                const viewBox = svg.match(/viewBox="([^"]+)"/)[1];
                const modifiedSvg = svg.replace(/<svg[^>]*>/, `<svg viewBox="${viewBox}">`);
                jobFlowDiv.innerHTML = modifiedSvg;

                const copyButton = createCopyButton(el.textContent);
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';

                const containerDiv = document.createElement('div');
                containerDiv.style.position = 'relative';
                containerDiv.appendChild(jobFlowDiv);
                containerDiv.appendChild(copyButton);
                el.parentNode.replaceChild(containerDiv, el);
            }

            document.querySelectorAll('pre code').forEach(processCodeBlock);

            mermaid.initialize({
                startOnLoad: true,
                securityLevel: 'loose',
                theme: 'default'
            });

            const deleteButtons = document.querySelectorAll('.delete-button');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const questionId = this.getAttribute('data-question-id');
                    if (confirm('Are you sure you want to delete this question?')) {
                        fetch(`/delete_question/${questionId}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.closest('.list-group-item').remove();
                                } else {
                                    alert('Failed to delete question');
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                });
            });

            const copyQuestionBtn = document.querySelector('.copy-question-btn');
            const questionText = document.querySelector('.question-card pre').textContent;
            
            copyQuestionBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(questionText).then(() => {
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        });
    </script>
</body>
</html>