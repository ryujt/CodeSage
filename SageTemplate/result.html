<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Answer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/styles/default.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        /* 전체 페이지 스타일 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }

        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }

        /* 사이드바 스타일 */
        #sidebar {
            width: 250px;
            min-height: 100vh;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
        }

        #content {
            flex: 1;
            padding: 20px;
            min-height: 100vh;
            margin-left: 250px;
            /* 사이드바 너비만큼 여백 추가 */
        }

        /* 네비게이션 바 스타일 */
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }

        /* 카드 스타일 */
        .card {
            background-color: #fff;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .1);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .card-body {
            padding: 20px;
        }

        /* 버튼 스타일 */
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #545b62;
        }

        /* 삭제 버튼 스타일 */
        .delete-button {
            color: #dc3545 !important;
            /* 빨간색 유지 */
            cursor: pointer;
            margin-left: 4px;
        }

        /* 마크다운 컨텐츠 스타일 */
        .answer {
            font-size: 16px;
            line-height: 1.6;
        }

        .answer h1,
        .answer h2,
        .answer h3,
        .answer h4,
        .answer h5,
        .answer h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        .answer h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        .answer h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: .3em;
        }

        .answer h3 {
            font-size: 1.25em;
        }

        .answer h4 {
            font-size: 1em;
        }

        .answer p {
            margin-top: 0;
            margin-bottom: 16px;
        }

        .answer a {
            color: #0366d6;
            text-decoration: none;
        }

        .answer a:hover {
            text-decoration: underline;
        }

        .answer pre {
            background-color: #f6f8fa;
            border-radius: 3px;
            padding: 16px;
            overflow: auto;
        }

        .answer code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 85%;
            background-color: rgba(27, 31, 35, .05);
            border-radius: 3px;
            padding: .2em .4em;
        }

        .answer blockquote {
            margin: 0;
            padding: 0 1em;
            color: #6a737d;
            border-left: .25em solid #dfe2e5;
        }

        .answer ul,
        .answer ol {
            padding-left: 2em;
            margin-bottom: 16px;
        }

        .answer li {
            margin-bottom: 0.25em;
        }

        /* 코드 블록 스타일 */
        .code-container {
            position: relative;
            margin-bottom: 16px;
        }

        .jobflow-container {
            position: relative;
            margin-bottom: 16px;
        }

        /* Copy 버튼 스타일 수정 */
        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 5px 10px;
            font-size: 12px;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            z-index: 10;
        }

        .copy-btn:hover {
            background-color: #0056b3;
        }

        /* Mermaid 다이어그램 스타일 */
        .mermaid {
            background-color: white;
            padding: 10px;
            margin-bottom: 16px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        /* JobFlow 다이어그램 스타일 */
        .jobflow-diagram {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            background-color: white;
            padding: 10px;
            margin-bottom: 16px;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, .1);
        }

        .jobflow-diagram svg {
            width: 100%;
            height: auto;
        }

        /* Copy Question 버튼 스타일 */
        .question-card {
            position: relative;
        }

        .copy-question-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            cursor: pointer;
        }

        .copy-question-btn:hover {
            background-color: #0056b3;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            #sidebar {
                width: 100%;
                position: static;
                height: auto;
            }

            #content {
                margin-left: 0;
                padding: 10px;
            }

            .card-header,
            .card-body {
                padding: 15px;
            }

            .copy-question-btn {
                position: static;
                margin-top: 10px;
                display: block;
                width: 100%;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="position-sticky pt-3">
                <h5 class="p-3">Question History</h5>
                <div class="list-group history">
                    {% for item in questions %}
                    <div
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('show_question', question_id=item.doc_id) }}" class="flex-grow-1">{{
                            item.title }}</a>
                        <i class="bi bi-trash delete-button" data-question-id="{{ item.doc_id }}"></i>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
                <div class="container-fluid">
                    <h1 class="header-title" onclick="window.location='/'">Code Sage</h1>
                </div>
            </nav>

            <div class="card mb-4 question-card">
                <div class="card-header">
                    <h5 class="card-title">Question</h5>
                    <button class="btn btn-sm btn-secondary copy-question-btn">Copy Question</button>
                </div>
                <div class="card-body">
                    <pre class="card-text">{{ question }}</pre>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Answer</h5>
                </div>
                <div class="card-body">
                    <div class="answer" id="answer-content">{{ answer | e }}</div>
                </div>
            </div>
            <a href="/" class="btn btn-primary mt-3">Ask Another Question</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.1/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://job-flow.s3.ap-northeast-2.amazonaws.com/jobflow.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const answerElement = document.getElementById('answer-content');
            const markdownContent = answerElement.textContent;
    
            const renderer = new marked.Renderer();
            const originalCodeRenderer = renderer.code.bind(renderer);
            
            renderer.code = function(code, language) {
                if (language === 'jobflow') {
                    const svg = JobFlowToSVG.generateSVG(code);
                    const viewBox = svg.match(/viewBox="([^"]+)"/)[1];
                    const modifiedSvg = svg.replace(/<svg[^>]*>/, `<svg viewBox="${viewBox}">`);
                    return `<div class="jobflow-diagram">${modifiedSvg}</div>`;
                }
                return originalCodeRenderer(code, language);
            };
            
            const htmlContent = marked.parse(markdownContent, { renderer: renderer });
            answerElement.innerHTML = htmlContent;
    
            function createCopyButton(text) {
                const button = document.createElement('button');
                button.textContent = 'Copy';
                button.className = 'btn btn-sm btn-secondary copy-btn';
                button.addEventListener('click', function () {
                    navigator.clipboard.writeText(text).then(() => {
                        button.textContent = 'Copied!';
                        setTimeout(() => {
                            button.textContent = 'Copy';
                        }, 2000);
                    });
                });
                return button;
            }
    
            function processCodeBlock(block) {
                if (block.classList.contains('language-mermaid')) {
                    processMermaidDiagram(block);
                } else if (block.classList.contains('language-jobflow')) {
                    processJobFlowDiagram(block);
                } else {
                    processStandardCodeBlock(block);
                }
            }

            function processStandardCodeBlock(el) {
                const mermaidDiv = document.createElement('div');
                mermaidDiv.classList.add('codeblock');
                mermaidDiv.textContent = el.textContent;
    
                const copyButton = createCopyButton(el.textContent);
                const containerDiv = document.createElement('div');
                containerDiv.style.position = 'relative';
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';
    
                containerDiv.appendChild(mermaidDiv);
                containerDiv.appendChild(copyButton);
                el.parentNode.replaceChild(containerDiv, el);
            }    
   
            function processMermaidDiagram(el) {
                const mermaidDiv = document.createElement('div');
                mermaidDiv.classList.add('mermaid');
                mermaidDiv.textContent = el.textContent;
    
                const copyButton = createCopyButton(el.textContent);
                const containerDiv = document.createElement('div');
                containerDiv.style.position = 'relative';
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';
    
                containerDiv.appendChild(mermaidDiv);
                containerDiv.appendChild(copyButton);
                el.parentNode.replaceChild(containerDiv, el);
            }
    
            function processJobFlowDiagram(el) {
                const jobFlowDiv = document.createElement('div');
                jobFlowDiv.classList.add('jobflow-diagram');
                const svg = JobFlowToSVG.generateSVG(el.textContent);
                const viewBox = svg.match(/viewBox="([^"]+)"/)[1];
                const modifiedSvg = svg.replace(/<svg[^>]*>/, `<svg viewBox="${viewBox}">`);
                jobFlowDiv.innerHTML = modifiedSvg;
    
                const copyButton = createCopyButton(el.textContent);
                copyButton.style.position = 'absolute';
                copyButton.style.top = '5px';
                copyButton.style.right = '5px';
    
                const containerDiv = document.createElement('div');
                containerDiv.style.position = 'relative';
                containerDiv.appendChild(jobFlowDiv);
                containerDiv.appendChild(copyButton);
                el.parentNode.replaceChild(containerDiv, el);
            }
    
            document.querySelectorAll('pre code').forEach(processCodeBlock);
    
            mermaid.initialize({
                startOnLoad: true,
                securityLevel: 'loose',
                theme: 'default'
            });
            
            const deleteButtons = document.querySelectorAll('.delete-button');
            deleteButtons.forEach(button => {
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    const questionId = this.getAttribute('data-question-id');
                    if (confirm('Are you sure you want to delete this question?')) {
                        fetch(`/delete_question/${questionId}`, { method: 'POST' })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    this.closest('.list-group-item').remove();
                                } else {
                                    alert('Failed to delete question');
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                });
            });
    
            const copyQuestionBtn = document.querySelector('.copy-question-btn');
            const questionText = document.querySelector('.question-card pre').textContent;
    
            copyQuestionBtn.addEventListener('click', function () {
                navigator.clipboard.writeText(questionText).then(() => {
                    const originalText = this.textContent;
                    this.textContent = 'Copied!';
                    setTimeout(() => {
                        this.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        });
    </script>
</body>

</html>